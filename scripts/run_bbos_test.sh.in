#!/bin/bash
#
#MSUB -N deltafs-bb-test
#MSUB -l walltime=0:10:00
#MSUB -l nodes=2:haswell
#MSUB -o /users/$USER/joblogs/deltafs-bbos-bench-$MOAB_JOBID.out
#MSUB -j oe
#DW jobdw access_mode=striped capacity=25GiB type=scratch
##DW stage_in type=directory source=/lustre/ttscratch1/users/$USER... destination=$DW_JOB_STRIPED
##DW stage_out type=directory source=$DW_JOB_STRIPED destination=/lustre/ttscratch1/users/$USER

#
# Tunables
#
num_bbos_client_nodes=1
num_bbos_server_nodes=1
num_cores=4

logfile=""
source @CMAKE_INSTALL_PREFIX@/scripts/common.sh

get_jobdir
gen_hostfile

logfile=$jobdir/deltafs-bb.log

touch $logfile

# get client and server nodes
bbos_client_nodes=$(echo "$all_nodes" | sort | head -n $num_bbos_client_nodes)
bbos_server_nodes=$(echo "$all_nodes" | sort | tail -n $num_bbos_server_nodes)

# Client transfer sizes we experiment with
OBJECT_CHUNK_SIZE=($((1*(2**20))))
#                   $((2*(2**20))))
#                   $((4*(2**20)))
#                   $((8*(2**20)))) # 1-8 MB

# Lustre sizes we experiment with
PFS_CHUNK_SIZE=($(( 8*(2**20))))
#                $((16*(2**20)))
#                $((32*(2**20)))
#                $((64*(2**20)))) # 8-64 MB

# message () { echo "$@" | tee -a $logfile; }

test_raw_bw() {
  svrs=$1
  env_vars=$2
  blocksize=$3
  count=$4
  num_servers=$5
  exe=@CMAKE_INSTALL_PREFIX@/bin/eval_bb

  message "RAW dd throughput: servers=$svrs bs=$blocksize count=$count"
  do_mpirun $num_servers 1 env_vars[@] "$svrs" "$exe" "$logfile"

  # Let the DDs finish on all the servers
  wait
}

start_server() {
  svr_name=$1
  env_vars=$2
  exe=@CMAKE_INSTALL_PREFIX@/bin/bbos_server

  message "Starting Server: server=$svr_name"
  do_mpirun 1 1 env_vars[@] "$svr_name" "$exe" "$logfile" &
}

start_clients() {
  clients=$1
  env_vars=$2
  num_clients=$3
  exe=@CMAKE_INSTALL_PREFIX@/bin/bbos_client

  message "Starting clients: clients=$clients"
  # SK: line below is a temporary fix to get each client to create an object
  # whose name is the same as the client. Eventually env variables will obviate
  # the need to do this.
  do_mpirun $num_clients 1 env_vars[@] "$clients" "$exe" "$logfile" &
}

kill_server() {
  svr_name=$1

  message "Killing server: server=$svr_name"
  do_mpirun 1 1 "" "$svr" "pkill -SIGINT bbos_server" "$logfile"
}

message "Clients: $bbos_client_nodes"
message "Servers: $bbos_server_nodes"

# Test the burst buffer
do_mpirun 1 1 "" "" "mkdir -p $bb_dir" "$logfile"
echo "Basic ls of Burst Buffer ..."
do_mpirun 1 1 "" "" "ls -l" "$logfile"

# First perform basic BB benchmarking loop across all servers
# BWS: This seems pointless, but whatever
# SK - Goal: estimate bandwidth to burst buffer
for c in ${PFS_CHUNK_SIZE[@]}; do
  count=$(((2**33) / c)) # 8 GB container file divided into count chunks of c MB each

  message "TRIAL BW Testing BB Chunk: $c"

  env_vars=("BB_Lustre_chunk_size" "$c"
            "BB_Max_container_size" "$((2**33))" "BB_Dummy_file"
            "$jobdir/\$(hostname)")
  # test_raw_bw $bbos_server_nodes "$env_vars" $c $count $num_bbos_server_nodes
  wait # have to wait
done

# Now perform client-server test
# SK: purposely kept separate client and server bases to avoid renaming all files

for pchunk in ${PFS_CHUNK_SIZE[@]}; do
  for hgchunk in ${OBJECT_CHUNK_SIZE[@]}; do
    message "TRIAL PFS Chunk: $pchunk Mercury Chunk: $hgchunk"

    # Start servers
    # BWS: Why do this one at a time? Seems crazy/complicated
    # SK: Because they have different initialization parameters.
    # This should be fixed when we go to env variables for initialization
    for svr in $(echo $bbos_server_nodes | sed "s/,/ /g"); do
      container_dir=$jobdir/containers-$pchunk-$hgchunk-$svr
      do_mpirun 1 1 "" "" "mkdir -p $container_dir" "$logfile"

      # SK: moved background inside start_server
      env_vars=("BB_Lustre_chunk_size" "$pchunk"
                "BB_Mercury_transfer_size" "$hgchunk" "BB_Num_workers" "4"
                "BB_Server_IP_address" "$svr" "BB_Output_dir" "$container_dir"
                "BB_Max_container_size" "$((2**33))" "BB_Object_dirty_threshold"
                "$((2**28))")
      start_server "$svr" "$env_vars"
    done
    sleep 3

    # Start client for each BB buddy on each node
    # Perform aprun once for all clients of the same server
    i=1
    j=1
    p=1
    num_clts=$((num_bbos_client_nodes / num_bbos_server_nodes))
    for svr in $(echo $bbos_server_nodes | sed "s/,/ /g"); do
      # filter=$(seq -s, $counter $j $((i * num_clts)))
      filter=$(seq -s, $j $((i * num_clts)))
      j=$(((i * num_clts) + 1))
      clts=$(echo $bbos_client_nodes | cut -d ' ' --fields $filter | tr ' ' ',' )
      echo "======== $clts bound to server $i ========="
      # one aprun for set of clients bound to one server

      for (( core = 0; core < num_cores; core++ )); do
        env_vars=("BB_Mercury_transfer_size" "$hgchunk"
        "BB_Object_size" "$((2**32))" "BB_Server_IP_address" "$svr"
        "BB_Core_num" "$core")
        start_clients "$clts" "$env_vars" $num_clts
        client_pids[$p]=$! # so that we can wait for clients to finish
        p=$((p+1))
      done
      # start_clients "$clts" "$env_vars" $num_clts
      # client_pids[$i]=$! # so that we can wait for clients to finish
      i=$((i+1))
    done

    # Waiting for clients to finish data transfer to server
    for c_pid in "${!client_pids[@]}"; do
      wait ${client_pids[$c_pid]}
    done

    # Send SIGINT to initiate server shutdown
    # SK: removed wait, see above
    for svr in $(echo $bbos_server_nodes | sed "s/,/ /g"); do
      kill_server $svr
    done

    # Waiting for servers to finish binpacking
    wait
  done
done

exit 0
