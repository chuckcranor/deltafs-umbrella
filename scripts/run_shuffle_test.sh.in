#!/bin/bash -eu

######################
# Tunable parameters #
######################

ip_subnet=${1:-"10.92"}
nodes=${2:-"16"}
cores_per_node=${3:-"4"}
init_procs_per_node=${4:-"1"}
procs_per_node_increase_step=${5:-"4"}

###############
# Core script #
###############

logfile=""
source @CMAKE_INSTALL_PREFIX@/scripts/common.sh

bbos_buddies=0

get_jobdir
gen_hosts

# keep track of start time so we can see how long this takes
timein=`date`

procs_per_node=$init_procs_per_node
while [ $procs_per_node -le $cores_per_node ]
do
    cores=$((procs_per_node * nodes))
    px=$((cores * 3)) #10
    py=$((10**2)) #100
    parts=$((px * py * 100))

    build_deck "file-per-particle" $px $py
    do_run "shuffle_test" $parts $procs_per_node

    if [ $procs_per_node -eq 1 ]; then
        procs_per_node=$procs_per_node_increase_step
    else
        procs_per_node=$(( procs_per_node + procs_per_node_increase_step ))
    fi
done

# overall time
timeout=`date`
message "Script complete."
message "start: ${timein}"
message "  end: ${timeout}"

exit 0